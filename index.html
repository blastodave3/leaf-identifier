<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Leaf Identifier</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #1a1a1a; color: white; margin: 0; padding: 20px; }
        #canvas-container { margin: 20px auto; display: inline-block; border: 3px solid #4CAF50; border-radius: 12px; overflow: hidden; background: #000; }
        button { padding: 15px 30px; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; }
        button:active { background: #45a049; }
        .loading-text { color: #aaa; font-style: italic; }
    </style>
</head>
<body>
    <h2>Tree Leaf Identifier</h2>
    <p id="status" class="loading-text">Loading Model...</p>
    
    <div id="canvas-container"></div>
    <br>
    <button id="start-btn" onclick="startCamera()">Start Camera</button>

    <script>
        // REPLACE with your Model URL
          let imageModelURL = 'https://teachablemachine.withgoogle.com/models/7ZyhWuPe7/';
        
        let classifier;
        let video;
        let flippedVideo;
        let label = "Waiting for camera...";
        let isModelLoaded = false;

        function preload() {
            classifier = ml5.imageClassifier(imageModelURL + 'model.json', () => {
                isModelLoaded = true;
                document.getElementById('status').innerText = "Model Ready! Tap Start.";
            });
        }

        function setup() {
            let canvas = createCanvas(320, 260);
            canvas.parent('canvas-container');
            background(0);
        }

       function startCamera() {
    let constraints = {
        video: { facingMode: { ideal: "environment" } },
        audio: false
    };

    // We pass the classifyVideo function AS a callback here 
    // so it only starts once the stream is 100% active
    video = createCapture(constraints, function(stream) {
        console.log("Stream active");
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('status').innerText = "Scanning...";
        classifyVideo(); // Start the AI now
    });

    video.size(320, 240);
    video.hide();
}

function classifyVideo() {
    // Check if the model is loaded AND the video is actually playing
    if (isModelLoaded && video && video.elt.readyState === 4) {
        classifier.classify(video, gotResult);
    } else {
        // If not ready, wait 100ms and try again
        setTimeout(classifyVideo, 100);
    }
}

function gotResult(error, results) {
    if (error) {
        console.error("AI Error:", error);
        return;
    }
    // Update the label variable which draw() uses
    if (results && results[0]) {
        label = results[0].label + " (" + floor(results[0].confidence * 100) + "%)";
    }
    classifyVideo(); // Loop
}

        function draw() {
            background(0);
            if (video) {
                // Draw the video to the canvas
                image(video, 0, 0, 320, 240);
                
                // Draw the label at the bottom
                fill(255);
                textSize(18);
                textAlign(CENTER);
                text(label, width / 2, height - 10);
            }
        }

        function classifyVideo() {
            if (isModelLoaded && video) {
                classifier.classify(video, gotResult);
            } else {
                // If model isn't ready, try again in 500ms
                setTimeout(classifyVideo, 500);
            }
        }

        function gotResult(error, results) {
            if (error) {
                console.error(error);
                return;
            }
            label = results[0].label + " (" + floor(results[0].confidence * 100) + "%)";
            classifyVideo();
        }
    </script>
</body>
</html>
